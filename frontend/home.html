<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline' cdnjs.cloudflare.com cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' 'unsafe-eval' 'unsafe-hashes' cdnjs.cloudflare.com cdn.jsdelivr.net; script-src-attr 'unsafe-inline' 'unsafe-hashes'; img-src 'self' data: https: http: blob:; connect-src 'self' ws: wss: http://localhost:3001 http://localhost:3002 http://localhost:3004 https:; worker-src 'self' blob:; child-src 'self' blob:; font-src 'self' data: https:; media-src 'self' data: blob: https:; object-src 'none'; frame-src 'self'">
  <title>Cho Nông Sản Số - Trang chủ</title>
  <link rel="stylesheet" href="style.css">
  <!-- Font Awesome CDN for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    .main-container {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 20px;
      max-width: 1200px;
      margin: 20px auto 0 auto;
      padding: 0 20px;
      min-height: 600px;
      align-items: start;
      width: 100%;
      box-sizing: border-box;
      min-width: 0;
    }
    .sidebar {
      width: 100%;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      padding: 24px 0 24px 0;
      margin: 0;
      height: auto;
      align-self: start;
      position: relative;
      top: 0;
      min-width: 0;
    }
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      width: 100%;
      background: none;
      box-shadow: none;
      margin: 0;
      padding: 0;
      min-width: 0;
    }
    .product-list {
      display: contents;
    }
    .product-card {
      background: #f7f8f9;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      padding: 18px 14px 20px 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: box-shadow 0.2s;
      width: 100%;
      min-width: 0;
    }
    .product-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.10);
    }
    
    /* Responsive breakpoints */
    @media (max-width: 900px) {
      .main-container {
        grid-template-columns: 1fr;
        gap: 16px;
        padding: 0 16px;
      }
      .sidebar {
        margin-bottom: 20px;
        position: static;
      }
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 16px;
      }
    }
    
    @media (max-width: 600px) {
      .main-container {
        margin: 15px auto 0 auto;
        padding: 0 12px;
        gap: 12px;
      }
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px;
      }
    }
    
    @media (max-width: 400px) {
      .main-container {
        padding: 0 8px;
      }
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-top text-center">
      <i class="fa-solid fa-truck-fast"></i> Miễn phí vận chuyển cho đơn hàng từ 500K!
    </div>
    <div class="header-main">
      <div class="header-container">
        <a href="#" class="logo"><i class="fa-solid fa-leaf"></i> Chợ Nông Sản Số</a>
        <div class="search-container">
          <form class="search-bar">
            <input type="text" class="search-input" placeholder="Tìm kiếm sản phẩm, danh mục...">
            <button type="submit" class="search-button" title="Tìm kiếm"><i class="fa fa-search"></i></button>
          </form>
        </div>
        <nav>
          <ul class="nav-list">
            <li class="nav-item"><a href="/home" class="nav-link"><i class="fa fa-home"></i> Trang chủ</a></li>
            <li class="nav-item"><a href="product.html" class="nav-link"><i class="fa fa-box"></i> Sản phẩm</a></li>
            <li class="nav-item"><a href="order.html" class="nav-link"><i class="fa fa-receipt"></i> Đơn hàng</a></li>
            <li class="nav-item"><a href="user.html" class="nav-link"><i class="fa fa-user"></i> Tài khoản</a></li>
            <li class="nav-item"><a href="cart.html" class="nav-link"><i class="fa fa-shopping-cart"></i> Giỏ hàng</a></li>
            <li class="nav-item" id="sellerDashboardNav" style="display: none;"><a href="seller-dashboard.html" class="nav-link" style="background:#667eea;color:#fff;border-radius:4px;padding:6px 16px;margin-left:8px;"><i class="fa fa-store"></i> Dashboard</a></li>
            <li class="nav-item"><a href="add-product.html" class="nav-link" style="background:var(--main-green);color:#fff;border-radius:4px;padding:6px 16px;margin-left:8px;"><i class="fa fa-plus"></i> Bán</a></li>
            <li class="nav-item"><a href="/login" class="nav-link logout-btn" onclick="logout()" style="background:#dc3545;color:#fff;border-radius:4px;padding:6px 16px;margin-left:8px;"><i class="fa fa-sign-out-alt"></i> Đăng xuất</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-container">
    <!-- Sidebar Categories -->
    <aside class="sidebar">
      <div class="sidebar-title"><i class="fa fa-list"></i> Danh mục</div>
      <ul class="category-list">
        <li class="category-item"><a href="category-rau-cu-qua.html" class="category-link"><i class="fa fa-carrot"></i> Rau củ quả</a></li>
        <li class="category-item"><a href="category-trai-cay.html" class="category-link"><i class="fa fa-apple-whole"></i> Trái cây</a></li>
        <li class="category-item"><a href="category-thit-ca.html" class="category-link"><i class="fa fa-fish"></i> Thịt cá</a></li>
        <li class="category-item"><a href="category-do-kho.html" class="category-link"><i class="fa fa-bacon"></i> Đồ khô</a></li>
        <li class="category-item"><a href="category-dac-san.html" class="category-link"><i class="fa fa-star"></i> Đặc sản vùng miền</a></li>
        <li class="category-item"><a href="category-sua-trung.html" class="category-link"><i class="fa fa-egg"></i> Sữa & Trứng</a></li>
      </ul>
    </aside>

    <!-- Products Grid -->
    <section class="products-grid" id="products-grid">
      <div id="product-list" class="product-list">
        <div class="skeleton-card">
          <div class="skeleton skeleton-image"></div>
          <div class="skeleton skeleton-text long"></div>
          <div class="skeleton skeleton-text medium"></div>
          <div class="skeleton skeleton-text short"></div>
          <div class="skeleton skeleton-button"></div>
        </div>
        <div class="skeleton-card">
          <div class="skeleton skeleton-image"></div>
          <div class="skeleton skeleton-text long"></div>
          <div class="skeleton skeleton-text medium"></div>
          <div class="skeleton skeleton-text short"></div>
          <div class="skeleton skeleton-button"></div>
        </div>
        <div class="skeleton-card">
          <div class="skeleton skeleton-image"></div>
          <div class="skeleton skeleton-text long"></div>
          <div class="skeleton skeleton-text medium"></div>
          <div class="skeleton skeleton-text short"></div>
          <div class="skeleton skeleton-button"></div>
        </div>
        <div class="skeleton-card">
          <div class="skeleton skeleton-image"></div>
          <div class="skeleton skeleton-text long"></div>
          <div class="skeleton skeleton-text medium"></div>
          <div class="skeleton skeleton-text short"></div>
          <div class="skeleton skeleton-button"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-container">
      <div class="footer-section">
        <h3>Về chúng tôi</h3>
        <ul>
          <li><a href="#"><i class="fa fa-info-circle"></i> Giới thiệu</a></li>
          <li><a href="#"><i class="fa fa-phone"></i> Liên hệ</a></li>
          <li><a href="#"><i class="fa fa-users"></i> Tuyển dụng</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h3>Hỗ trợ khách hàng</h3>
        <ul>
          <li><a href="#"><i class="fa fa-undo"></i> Chính sách đổi trả</a></li>
          <li><a href="#"><i class="fa fa-shield-alt"></i> Chính sách bảo mật</a></li>
          <li><a href="#"><i class="fa fa-question-circle"></i> Câu hỏi thường gặp</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h3>Kết nối với chúng tôi</h3>
        <ul>
          <li><a href="#"><i class="fab fa-facebook"></i> Facebook</a></li>
          <li><a href="#"><i class="fab fa-facebook-messenger"></i> Zalo</a></li>
          <li><a href="#"><i class="fab fa-instagram"></i> Instagram</a></li>
        </ul>
      </div>
    </div>
  </footer>

  <!-- Trace Modal -->
  <div id="trace-modal" class="modal" style="display:none;">
    <div class="modal-content" id="trace-modal-content">
      <!-- Nội dung sẽ được JS render -->
    </div>
  </div>

  <!-- Our JavaScript utilities -->
  <script src="js/utils.js"></script>
  <script src="js/api.js"></script>
  
  <script>
    // Wait for all utils to be ready
    function waitForUtils() {
      return new Promise((resolve) => {
        let attempts = 0;
        const maxAttempts = 40; // 2 seconds max
        
        function check() {
          if (window.loadingManager && window.ApiService) {
            resolve();
          } else if (attempts < maxAttempts) {
            attempts++;
            setTimeout(check, 50);
          } else {
            console.warn('Utils not loaded in time, proceeding anyway');
            resolve();
          }
        }
        check();
      });
    }

    // Simple fallback toast
    function showToast(message, type = 'info') {
      if (window.toastManager) {
        window.toastManager[type](message);
      } else {
        alert(message); // Simple fallback
      }
    }

    // Load products using new API service
    async function loadProducts() {
      const list = document.getElementById('product-list');
      
      // Show skeleton loading (static HTML)
      list.innerHTML = `
        <div class="skeleton-card">
          <div class="skeleton skeleton-image"></div>
          <div class="skeleton skeleton-text long"></div>
          <div class="skeleton skeleton-text medium"></div>
          <div class="skeleton skeleton-text short"></div>
          <div class="skeleton skeleton-button"></div>
        </div>
        <div class="skeleton-card">
          <div class="skeleton skeleton-image"></div>
          <div class="skeleton skeleton-text long"></div>
          <div class="skeleton skeleton-text medium"></div>
          <div class="skeleton skeleton-text short"></div>
          <div class="skeleton skeleton-button"></div>
        </div>
        <div class="skeleton-card">
          <div class="skeleton skeleton-image"></div>
          <div class="skeleton skeleton-text long"></div>
          <div class="skeleton skeleton-text medium"></div>
          <div class="skeleton skeleton-text short"></div>
          <div class="skeleton skeleton-button"></div>
        </div>
        <div class="skeleton-card">
          <div class="skeleton skeleton-image"></div>
          <div class="skeleton skeleton-text long"></div>
          <div class="skeleton skeleton-text medium"></div>
          <div class="skeleton skeleton-text short"></div>
          <div class="skeleton skeleton-button"></div>
        </div>
      `;
      
      try {
        let data;
        if (typeof ApiService !== 'undefined') {
          data = await ApiService.getProducts();
        } else {
          // Fallback: call API directly
          const response = await fetch('http://localhost:3001/api/products');
          data = await response.json();
        }
        
        const products = data.data || [];
        
        if (!Array.isArray(products) || products.length === 0) {
          list.innerHTML = `<div style='font-size:20px; color:var(--text-secondary); margin-bottom:8px;'>Chưa có sản phẩm nào</div>`;
        } else {
          list.innerHTML = products.map((product, index) => `
            <div class='product-card fade-in' style='animation-delay: ${index * 0.1}s'>
              <img data-src='${product.imageUrls && product.imageUrls.length > 0 ? ('http://localhost:3001' + product.imageUrls[0]) : 'https://via.placeholder.com/120x120?text=No+Image'}' 
                   alt='${product.name}' 
                   class='product-image lazy-image' 
                   style='width:120px;height:120px;object-fit:cover;border-radius:8px;'/>
              <div class='product-name' style='font-weight:bold; margin-top:8px;'>${product.name}</div>
              <div class='product-price' style='color:var(--main-green);'>${product.price.toLocaleString('vi-VN')}₫${product.unit ? ' / ' + product.unit : ''}</div>
              <div class='product-desc' style='font-size:14px; color:#888; margin-top:4px;'>${product.description || ''}</div>
              <div style='display:flex;gap:8px;margin-top:14px;'>
                <button class='add-to-cart-btn' style='flex:1;padding:8px 12px;font-size:15px;background:var(--main-green);color:#fff;border:none;border-radius:6px;cursor:pointer;' onclick="addProductToCart('${product._id}')">
                  <i class='fa fa-cart-plus'></i> Thêm vào giỏ
                </button>
                <button class='btn-trace btn btn-secondary' style='flex:1;padding:8px 12px;font-size:15px;background:#3498db;color:#fff;' onclick="traceProduct('${product._id}')">
                  <i class='fa fa-link'></i> Truy xuất
                </button>
              </div>
            </div>
          `).join('');
          
          // Initialize lazy loading for images
          document.querySelectorAll('.lazy-image').forEach(img => {
            if (typeof lazyImageLoader !== 'undefined') {
              lazyImageLoader.observe(img);
            } else {
              // Fallback: set src directly
              img.src = img.dataset.src;
              img.classList.add('loaded');
            }
          });
          
          // Add animation to product cards
          document.querySelectorAll('.product-card').forEach((card, index) => {
            setTimeout(() => {
              if (typeof animateElement !== 'undefined') {
                animateElement(card, 'fade-in');
              } else {
                card.classList.add('fade-in');
              }
            }, index * 100);
          });
        }
      } catch (error) {
        console.error('Load products error:', error);
        list.innerHTML = `<div style='color:red;text-align:center;padding:40px;'>
          <i class="fa fa-exclamation-triangle" style="font-size:48px;margin-bottom:16px;"></i>
          <div style="font-size:18px;margin-bottom:8px;">Không thể tải sản phẩm</div>
          <div style="font-size:14px;color:#666;">Lỗi: ${error.message}</div>
        </div>`;
      }
    }

    function orderProduct(productId) {
      window.location.href = `order.html?id=${productId}`;
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      waitForUtils().then(() => {
        loadProducts();
      });
    });

    async function traceProduct(productId) {
      // Clean product ID
      if (typeof productId === 'string' && productId.startsWith('ObjectId(')) {
        productId = productId.replace('ObjectId(', '').replace(')', '').replace(/'/g, '');
      }
      
      const modal = document.getElementById('trace-modal');
      const modalContent = document.getElementById('trace-modal-content');
      
      // Show loading in modal
      modalContent.innerHTML = '<div style="text-align:center;padding:20px;"><i class="fa fa-spinner fa-spin" style="font-size:24px;color:var(--main-green);"></i><p>Đang tải thông tin truy xuất nguồn gốc...</p></div>';
      modal.style.display = 'flex';
      
      try {
        let data;
        if (typeof ApiService !== 'undefined') {
          data = await ApiService.traceProduct(productId);
        } else {
          // Fallback: call API directly
          const response = await fetch(`http://localhost:3001/api/products/${productId}/trace`);
          data = await response.json();
        }
        
        if (data.success && data.data) {
          const trace = data.data.trace;
          modalContent.innerHTML = `
            <div class="trace-header">
              <h3><i class="fa fa-link"></i> Truy xuất nguồn gốc sản phẩm</h3>
              <button onclick="closeTraceModal()" class="close-btn">&times;</button>
            </div>
            <div class="trace-info" style="display:flex;align-items:flex-start;gap:16px;">
              <div style="flex:1;min-width:0;">
                <div class="trace-item"><strong>Tên sản phẩm:</strong> ${trace.productName}</div>
                <div class="trace-item"><strong>Danh mục:</strong> ${trace.category}</div>
                <div class="trace-item"><strong>Giá:</strong> ${trace.price.toLocaleString('vi-VN')} VNĐ/${trace.unit}</div>
                <div class="trace-item"><strong>Blockchain Hash:</strong> <span style="font-family:monospace;font-size:12px;">${trace.blockchainHash}</span></div>
                <div class="trace-item"><strong>Thời gian tạo:</strong> ${new Date(trace.timestamp).toLocaleString('vi-VN')}</div>
              </div>
              <div id="qrcode-modal" style="min-width:90px;"></div>
            </div>
            <div class="supply-chain">
              <h4><i class="fa fa-route"></i> Chuỗi cung ứng</h4>
              ${trace.supplyChain.map((step, index) => `
                <div class="supply-step">
                  <div class="step-number">${index + 1}</div>
                  <div class="step-info">
                    <div class="step-title">${step.step}</div>
                    <div class="step-location">${step.location}</div>
                    <div class="step-description">${step.description}</div>
                    <div class="step-time">${new Date(step.timestamp).toLocaleString('vi-VN')}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
          var url = window.location.origin + '/product.html?id=' + productId;
          if (document.getElementById('qrcode-modal')) {
            document.getElementById('qrcode-modal').innerHTML = '';
            new QRCode(document.getElementById('qrcode-modal'), {
              text: url,
              width: 150,
              height: 150
            });
          }
        } else {
          modalContent.innerHTML = `
            <div class="trace-header">
              <h3><i class="fa fa-exclamation-triangle"></i> Lỗi truy xuất</h3>
              <button onclick="closeTraceModal()" class="close-btn">&times;</button>
            </div>
            <div style="text-align:center;padding:20px;color:#e74c3c;">
              <p>Không thể tải thông tin truy xuất nguồn gốc!</p>
              <p>${data.message || 'Vui lòng thử lại sau.'}</p>
            </div>
          `;
        }
      } catch (error) {
        modalContent.innerHTML = `
          <div class="trace-header">
            <h3><i class="fa fa-exclamation-triangle"></i> Lỗi kết nối</h3>
            <button onclick="closeTraceModal()" class="close-btn">&times;</button>
          </div>
          <div style="text-align:center;padding:20px;color:#e74c3c;">
            <p>Lỗi kết nối server!</p>
            <p>Vui lòng kiểm tra kết nối và thử lại.</p>
          </div>
        `;
      }
    }
    function closeTraceModal() {
      document.getElementById('trace-modal').style.display = 'none';
    }

    // Check authentication with retry logic
    function checkAuth(retryCount = 0) {
      const token = localStorage.getItem('token');
      const user = localStorage.getItem('user');
      
      // If no token/user and we haven't retried much, wait a bit
      if ((!token || !user) && retryCount < 3) {
        console.log(`Auth check attempt ${retryCount + 1}/3, waiting...`);
        setTimeout(() => checkAuth(retryCount + 1), 200);
        return;
      }
      
      if (!token || !user) {
        console.log('No valid authentication found, redirecting to login');
        window.location.replace('/login');
        return false;
      }
      
      try {
        const userData = JSON.parse(user);
        console.log('User authenticated:', userData);
        
        // Show success message briefly
        const body = document.body;
        const successMsg = document.createElement('div');
        successMsg.innerHTML = `
          <div style="position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 10px 20px; border-radius: 8px; z-index: 9999; font-family: Arial, sans-serif;">
            <i class="fa fa-check-circle"></i> Đăng nhập thành công! Chào mừng ${userData.fullName || userData.username}
          </div>
        `;
        body.appendChild(successMsg);
        
        setTimeout(() => {
          if (successMsg.parentNode) {
            successMsg.parentNode.removeChild(successMsg);
          }
        }, 3000);
        
        // Show seller dashboard link if user is a seller
        if (userData.role === 'seller') {
          const sellerNav = document.getElementById('sellerDashboardNav');
          if (sellerNav) {
            sellerNav.style.display = 'block';
          }
        }
        
        return true;
      } catch (error) {
        console.error('Invalid user data:', error);
        // Clear invalid data and redirect
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.replace('/login');
        return false;
      }
    }

    // Logout function
    function logout() {
      // Clear authentication tokens
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      sessionStorage.removeItem('token');
      sessionStorage.removeItem('user');
      
      // Also clear any legacy tokens
      localStorage.removeItem('authToken');
      sessionStorage.removeItem('authToken');
      localStorage.removeItem('userRole');
      sessionStorage.removeItem('userRole');
      
      // Redirect to login page
      window.location.href = '/login';
    }

    // Check authentication when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Home page DOM loaded, checking authentication...');
      checkAuth();
    });
  </script>

  <!-- 🚀 PERFORMANCE OPTIMIZATION SYSTEM -->
  <script src="js/lazyLoader.js"></script>
  <script src="js/imageOptimizer.js"></script>
  <script src="js/assetOptimizer.js"></script>
  <script src="js/performanceDashboard.js"></script>
  <script src="js/optimizationInit.js"></script>

  <!-- 🛒 SHOPPING CART SYSTEM -->
  <script src="js/cart.js?v=2025.1.16"></script>
  
  <!-- 📊 ANALYTICS SYSTEM -->
  <script src="js/analytics.js?v=2025.1.16"></script>
  
  <script>
    // Add to cart functionality for product cards
    async function addProductToCart(productId) {
      try {
        const response = await fetch(`http://localhost:3001/api/products/${productId}`);
        const result = await response.json();
        
        if (result.success && result.data) {
          addToCart(result.data);
          
          // Track add to cart event
          if (window.analytics) {
            window.analytics.trackEcommerce('add_to_cart', {
              productId: result.data.id,
              productName: result.data.name,
              price: result.data.price,
              quantity: 1
            });
          }
        } else {
          alert('Không thể thêm sản phẩm vào giỏ hàng!');
        }
      } catch (error) {
        console.error('Add to cart error:', error);
        alert('Có lỗi xảy ra khi thêm vào giỏ hàng!');
        
        // Track error
        if (window.analytics) {
          window.analytics.trackError('add_to_cart_error', {
            productId,
            error: error.message
          });
        }
      }
    }
    
    // Track page view
    document.addEventListener('DOMContentLoaded', function() {
      if (window.analytics) {
        window.analytics.track('home_page_view', {
          page: 'home',
          timestamp: new Date().toISOString()
        });
      }
    });
  </script>

</body>
</html>
