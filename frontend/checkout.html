<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thanh toán - Chợ Nông Sản Số</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .checkout-container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 40px;
    }
    
    .checkout-main {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    
    .checkout-header {
      background: linear-gradient(135deg, var(--main-green), #45a049);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .checkout-header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 600;
    }
    
    .checkout-steps {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }
    
    .step {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      background: rgba(255,255,255,0.2);
      font-size: 14px;
      font-weight: 500;
    }
    
    .step.active {
      background: rgba(255,255,255,0.3);
    }
    
    .checkout-content {
      padding: 40px;
    }
    
    .form-section {
      margin-bottom: 40px;
    }
    
    .form-section h3 {
      color: #333;
      font-size: 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--main-green);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .payment-methods-container {
      margin-bottom: 20px;
    }
    
    .payment-method {
      position: relative;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 15px;
    }
    
    .payment-method-label {
      display: block;
      cursor: pointer;
      width: 100%;
    }
    
    .payment-method-content {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .payment-method-icon {
      font-size: 24px;
      min-width: 40px;
    }
    
    .payment-method-info h4 {
      margin: 0 0 5px 0;
      font-size: 16px;
      color: #333;
    }
    
    .payment-method-info p {
      margin: 0;
      font-size: 12px;
      color: #666;
    }
    
    .payment-method input[type="radio"] {
      margin-right: 15px;
    }
    
    .payment-method:hover {
      border-color: var(--main-green);
      background-color: #f8f9fa;
    }
    
    .payment-method input[type="radio"]:checked + .payment-method-content {
      color: var(--main-green);
    }
    
    .payment-form {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .payment-method-details h4 {
      margin: 0 0 15px 0;
      font-size: 18px;
      color: #333;
    }
    
    .payment-features {
      display: flex;
      gap: 20px;
      margin-top: 15px;
    }
    
    .feature {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #666;
    }
    
    .momo-options {
      display: flex;
      gap: 20px;
      margin-top: 15px;
    }
    
    .momo-option {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #666;
    }
    
    .bank-details {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .bank-item {
      padding: 5px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .bank-item:last-child {
      border-bottom: none;
    }
    
    .qr-code-container {
      text-align: center;
      padding: 20px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
    }
    
    .qr-placeholder {
      font-size: 48px;
      color: #ccc;
    }
    
    .qr-placeholder p {
      font-size: 14px;
      margin-top: 10px;
      color: #666;
    }
    
    .cod-details {
      margin-bottom: 15px;
    }
    
    .cod-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      color: #666;
    }
    
    .cod-item i {
      color: var(--main-green);
    }
    
    .cod-note {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 6px;
      padding: 10px;
      font-size: 14px;
      color: #856404;
    }
    
    .payment-method:hover {
      border-color: var(--main-green);
      transform: translateY(-2px);
    }
    
    .payment-method.selected {
      border-color: var(--main-green);
      background: rgba(76, 175, 80, 0.05);
    }
    
    .payment-method input[type="radio"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .payment-method i {
      font-size: 24px;
      margin-bottom: 8px;
      color: var(--main-green);
    }
    
    .order-summary {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      position: sticky;
      top: 20px;
    }
    
    .summary-header {
      background: #f8f9fa;
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
      border-radius: 12px 12px 0 0;
    }
    
    .summary-header h3 {
      margin: 0;
      color: #333;
      font-size: 18px;
    }
    
    .summary-content {
      padding: 20px;
    }
    
    .order-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .order-item:last-child {
      border-bottom: none;
    }
    
    .item-image {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 6px;
    }
    
    .item-details {
      flex: 1;
    }
    
    .item-name {
      font-weight: 500;
      color: #333;
      font-size: 14px;
    }
    
    .item-quantity {
      color: #666;
      font-size: 12px;
    }
    
    .item-price {
      font-weight: 600;
      color: var(--main-green);
    }
    
    .summary-totals {
      border-top: 1px solid #e0e0e0;
      padding-top: 15px;
      margin-top: 15px;
    }
    
    .total-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .total-row.final {
      font-weight: 600;
      font-size: 18px;
      color: var(--main-green);
      border-top: 1px solid #e0e0e0;
      padding-top: 15px;
      margin-top: 15px;
    }
    
    .place-order-btn {
      width: 100%;
      background: linear-gradient(135deg, var(--main-green), #45a049);
      color: white;
      border: none;
      padding: 16px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 20px;
    }
    
    .place-order-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(76, 175, 80, 0.3);
    }
    
    .place-order-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .security-badges {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }
    
    .security-badge {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 12px;
      color: #666;
    }
    
    .credit-card-form {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-top: 15px;
      display: none;
    }
    
    .credit-card-form.active {
      display: block;
    }
    
    @media (max-width: 768px) {
      .checkout-container {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .payment-methods {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="checkout-container">
    <!-- Main Checkout Form -->
    <div class="checkout-main">
      <div class="checkout-header">
        <h1><i class="fas fa-credit-card"></i> Thanh toán</h1>
        <div class="checkout-steps">
          <div class="step active">
            <i class="fas fa-shopping-cart"></i>
            Giỏ hàng
          </div>
          <div class="step active">
            <i class="fas fa-truck"></i>
            Giao hàng
          </div>
          <div class="step active">
            <i class="fas fa-credit-card"></i>
            Thanh toán
          </div>
          <div class="step">
            <i class="fas fa-check"></i>
            Hoàn thành
          </div>
        </div>
      </div>

      <div class="checkout-content">
        <form id="checkout-form">
          <!-- Shipping Information -->
          <div class="form-section">
            <h3><i class="fas fa-truck"></i> Thông tin giao hàng</h3>
            
            <div class="form-row">
              <div class="form-group">
                <label for="fullName">Họ và tên *</label>
                <input type="text" id="fullName" name="fullName" required>
              </div>
              <div class="form-group">
                <label for="phone">Số điện thoại *</label>
                <input type="tel" id="phone" name="phone" required>
              </div>
            </div>
            
            <div class="form-group">
              <label for="email">Email</label>
              <input type="email" id="email" name="email">
            </div>
            
            <div class="form-group">
              <label for="address">Địa chỉ giao hàng *</label>
              <textarea id="address" name="address" rows="3" required placeholder="Số nhà, tên đường, phường/xã, quận/huyện, tỉnh/thành phố"></textarea>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="deliveryDate">Ngày giao hàng mong muốn</label>
                <input type="date" id="deliveryDate" name="deliveryDate">
              </div>
              <div class="form-group">
                <label for="deliveryTime">Thời gian giao hàng</label>
                <select id="deliveryTime" name="deliveryTime">
                  <option value="">Chọn thời gian</option>
                  <option value="morning">Sáng (8h - 12h)</option>
                  <option value="afternoon">Chiều (13h - 17h)</option>
                  <option value="evening">Tối (18h - 21h)</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Payment Method -->
          <div class="form-section">
            <h3><i class="fas fa-credit-card"></i> Phương thức thanh toán</h3>
            
            <div id="payment-methods" class="payment-methods-container">
              <!-- Payment methods will be loaded here by payment.js -->
            </div>

            <!-- Payment Method Forms -->
            <div id="vnpay-form" class="payment-form" style="display: none;">
              <div class="payment-method-details">
                <h4>🏦 Thanh toán VNPay</h4>
                <div class="payment-info">
                  <p>Bạn sẽ được chuyển hướng đến cổng thanh toán VNPay để hoàn tất giao dịch.</p>
                  <div class="payment-features">
                    <div class="feature">
                      <i class="fa fa-shield-alt"></i>
                      <span>Bảo mật cao</span>
                    </div>
                    <div class="feature">
                      <i class="fa fa-credit-card"></i>
                      <span>Hỗ trợ nhiều ngân hàng</span>
                    </div>
                    <div class="feature">
                      <i class="fa fa-mobile-alt"></i>
                      <span>Thanh toán nhanh</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="momo-form" class="payment-form" style="display: none;">
              <div class="payment-method-details">
                <h4>📱 Thanh toán MoMo</h4>
                <div class="payment-info">
                  <p>Sử dụng ví điện tử MoMo để thanh toán nhanh chóng và an toàn.</p>
                  <div class="momo-options">
                    <div class="momo-option">
                      <i class="fa fa-qrcode"></i>
                      <span>Quét mã QR</span>
                    </div>
                    <div class="momo-option">
                      <i class="fa fa-mobile-alt"></i>
                      <span>Mở app MoMo</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="banking-form" class="payment-form" style="display: none;">
              <div class="payment-method-details">
                <h4>💳 Chuyển khoản ngân hàng</h4>
                <div class="bank-info">
                  <div class="bank-details">
                    <div class="bank-item">
                      <strong>Tên tài khoản:</strong> CHO NONG SAN SO
                    </div>
                    <div class="bank-item">
                      <strong>Số tài khoản:</strong> 1234567890
                    </div>
                    <div class="bank-item">
                      <strong>Ngân hàng:</strong> Vietcombank
                    </div>
                    <div class="bank-item">
                      <strong>Nội dung:</strong> THANHTOAN ORDER[MÃ ĐƠN HÀNG]
                    </div>
                  </div>
                  <div class="qr-banking">
                    <p>Hoặc quét mã QR để chuyển khoản:</p>
                    <div class="qr-code-container">
                      <div class="qr-placeholder">
                        <i class="fa fa-qrcode"></i>
                        <p>QR Code sẽ được tạo khi thanh toán</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="cod-form" class="payment-form" style="display: none;">
              <div class="payment-method-details">
                <h4>💰 Thanh toán khi nhận hàng (COD)</h4>
                <div class="cod-info">
                  <div class="cod-details">
                    <div class="cod-item">
                      <i class="fa fa-check-circle"></i>
                      <span>Thanh toán bằng tiền mặt khi nhận hàng</span>
                    </div>
                    <div class="cod-item">
                      <i class="fa fa-truck"></i>
                      <span>Shipper sẽ thu tiền và giao hàng</span>
                    </div>
                    <div class="cod-item">
                      <i class="fa fa-shield-alt"></i>
                      <span>Kiểm tra hàng trước khi thanh toán</span>
                    </div>
                  </div>
                  <div class="cod-note">
                    <p><strong>Lưu ý:</strong> Vui lòng chuẩn bị đủ tiền mặt khi nhận hàng.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Order Notes -->
          <div class="form-section">
            <h3><i class="fas fa-sticky-note"></i> Ghi chú đơn hàng</h3>
            <div class="form-group">
              <textarea id="orderNotes" name="orderNotes" rows="3" placeholder="Ghi chú thêm cho đơn hàng (tùy chọn)"></textarea>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Order Summary -->
    <div class="order-summary">
      <div class="summary-header">
        <h3><i class="fas fa-receipt"></i> Tóm tắt đơn hàng</h3>
      </div>
      
      <div class="summary-content">
        <div id="order-items">
          <!-- Order items will be populated by JavaScript -->
        </div>
        
        <div class="summary-totals">
          <div class="total-row">
            <span>Tạm tính:</span>
            <span id="subtotal">0₫</span>
          </div>
          <div class="total-row">
            <span>Phí vận chuyển:</span>
            <span id="shipping-fee">30,000₫</span>
          </div>
          <div class="total-row">
            <span>Giảm giá:</span>
            <span id="discount">0₫</span>
          </div>
          <div class="total-row final">
            <span>Tổng cộng:</span>
            <span id="total">0₫</span>
          </div>
        </div>
        
        <button type="submit" form="checkout-form" class="place-order-btn" id="place-order-btn">
          <i class="fas fa-lock"></i> Đặt hàng an toàn
        </button>
        
        <div class="security-badges">
          <div class="security-badge">
            <i class="fas fa-shield-alt"></i>
            Bảo mật SSL
          </div>
          <div class="security-badge">
            <i class="fas fa-lock"></i>
            Thanh toán an toàn
          </div>
          <div class="security-badge">
            <i class="fas fa-undo"></i>
            Đổi trả miễn phí
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
    <div style="background: white; padding: 40px; border-radius: 12px; text-align: center;">
      <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--main-green); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
      <h3>Đang xử lý đơn hàng...</h3>
      <p>Vui lòng không tắt trang này</p>
    </div>
  </div>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <!-- Scripts -->
      <script src="js/cart.js?v=2025.1.16"></script>
  <script src="js/payment.js"></script>
  <script src="js/analytics.js?v=2025.1.16"></script>
  <script>
    let checkoutCart = [];
    const SHIPPING_FEE = 30000;

    // Success Modal Function
    function showSuccessModal(data) {
      // Create modal HTML
      const modalHTML = `
        <div id="success-modal" style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
          animation: fadeIn 0.3s ease-out;
        ">
          <div style="
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            animation: slideUp 0.3s ease-out;
          ">
            <div style="
              width: 80px;
              height: 80px;
              background: var(--main-green);
              border-radius: 50%;
              margin: 0 auto 20px;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 40px;
              color: white;
            ">✓</div>
            
            <h2 style="
              color: var(--main-green);
              margin-bottom: 15px;
              font-size: 28px;
            ">${data.title}</h2>
            
            <p style="
              color: #666;
              margin-bottom: 30px;
              font-size: 16px;
              line-height: 1.5;
            ">${data.message}</p>
            
            <div style="
              display: flex;
              gap: 15px;
              justify-content: center;
            ">
              <button onclick="closeSuccessModal()" style="
                background: var(--main-green);
                color: white;
                border: none;
                padding: 12px 30px;
                border-radius: 25px;
                cursor: pointer;
                font-size: 16px;
                font-weight: 500;
                transition: all 0.3s ease;
              " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                Tiếp tục mua sắm
              </button>
              
              <button onclick="goToHome()" style="
                background: transparent;
                color: var(--main-green);
                border: 2px solid var(--main-green);
                padding: 12px 30px;
                border-radius: 25px;
                cursor: pointer;
                font-size: 16px;
                font-weight: 500;
                transition: all 0.3s ease;
              " onmouseover="this.style.background='var(--main-green)'; this.style.color='white'" onmouseout="this.style.background='transparent'; this.style.color='var(--main-green)'">
                Về trang chủ
              </button>
            </div>
          </div>
        </div>
        
                 <style>
           @keyframes fadeIn {
             from { opacity: 0; }
             to { opacity: 1; }
           }
           
           @keyframes fadeOut {
             from { opacity: 1; }
             to { opacity: 0; }
           }
           
           @keyframes slideUp {
             from { transform: translateY(30px); opacity: 0; }
             to { transform: translateY(0); opacity: 1; }
           }
         </style>
      `;
      
      // Add modal to page
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
    }

    function closeSuccessModal() {
      const modal = document.getElementById('success-modal');
      if (modal) {
        modal.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => {
          modal.remove();
          document.body.style.overflow = 'auto';
        }, 300);
      }
    }

    function goToHome() {
      closeSuccessModal();
      window.location.href = '/home';
    }
    
    // Initialize checkout page
    document.addEventListener('DOMContentLoaded', () => {
      loadCheckoutData();
      setupFormValidation();
      setupPaymentMethodHandlers();
      setupCardFormatting();
      setMinDeliveryDate();
      
      // Track checkout page view
      if (window.analytics) {
        window.analytics.track('checkout_page_view', {
          page: 'checkout',
          cart_items: checkoutCart.length,
          timestamp: new Date().toISOString()
        });
        
        // Track begin checkout event
        const cartTotal = checkoutCart.reduce((total, item) => total + (item.price * item.quantity), 0);
        window.analytics.trackEcommerce('begin_checkout', {
          items: checkoutCart,
          totalValue: cartTotal
        });
      }
    });

    // Load checkout data from localStorage
    function loadCheckoutData() {
      const cartData = localStorage.getItem('checkout_cart');
      if (!cartData) {
        alert('Không có sản phẩm nào để thanh toán!');
        window.location.href = 'cart.html';
        return;
      }
      
      checkoutCart = JSON.parse(cartData);
      renderOrderSummary();
    }

    // Render order summary
    function renderOrderSummary() {
      const orderItemsContainer = document.getElementById('order-items');
      const subtotalElement = document.getElementById('subtotal');
      const totalElement = document.getElementById('total');
      
      let subtotal = 0;
      let itemsHTML = '';
      
      checkoutCart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        
        itemsHTML += `
          <div class="order-item">
            <img src="${item.imageUrl ? 'http://localhost:3001' + item.imageUrl : 'https://via.placeholder.com/50x50?text=No+Image'}" 
                 alt="${item.name}" class="item-image">
            <div class="item-details">
              <div class="item-name">${item.name}</div>
              <div class="item-quantity">Số lượng: ${item.quantity}${item.unit ? ' ' + item.unit : ''}</div>
            </div>
            <div class="item-price">${itemTotal.toLocaleString('vi-VN')}₫</div>
          </div>
        `;
      });
      
      orderItemsContainer.innerHTML = itemsHTML;
      subtotalElement.textContent = subtotal.toLocaleString('vi-VN') + '₫';
      
      const total = subtotal + SHIPPING_FEE;
      totalElement.textContent = total.toLocaleString('vi-VN') + '₫';
    }

    // Select payment method
    function selectPaymentMethod(method) {
      // Remove active class from all methods
      document.querySelectorAll('.payment-method').forEach(el => {
        el.classList.remove('selected');
      });
      
      // Add active class to selected method
      event.currentTarget.classList.add('selected');
      
      // Check the radio button
      document.getElementById(method).checked = true;
      
      // Show/hide credit card form
      const cardForm = document.getElementById('credit-card-form');
      if (method === 'card') {
        cardForm.classList.add('active');
      } else {
        cardForm.classList.remove('active');
      }
    }

    // Setup form validation
    function setupFormValidation() {
      const form = document.getElementById('checkout-form');
      form.addEventListener('submit', handleFormSubmit);
    }

    // Handle form submission
    async function handleFormSubmit(e) {
      e.preventDefault();
      
      if (!validateForm()) {
        return;
      }
      
      showLoading(true);
      
      try {
        const orderData = collectFormData();
        const response = await submitOrder(orderData);
        
        if (response.success) {
                  // Clear cart
        localStorage.removeItem('checkout_cart');
        localStorage.removeItem('cho_nong_san_cart');
        
        // Show success notification instead of redirect
        showSuccessModal({
          title: 'Đặt hàng thành công!',
          message: `Cảm ơn bạn đã đặt hàng. Mã đơn hàng: ${response.data.orderId || 'CHO-' + Date.now()}`,
          orderInfo: response.data
        });
        } else {
          throw new Error(response.message || 'Có lỗi xảy ra khi đặt hàng');
        }
        
      } catch (error) {
        console.error('Order error:', error);
        alert('Có lỗi xảy ra: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    // Validate form
    function validateForm() {
      const required = ['fullName', 'phone', 'address'];
      const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
      
      // Check required fields
      for (let field of required) {
        const element = document.getElementById(field);
        if (!element.value.trim()) {
          element.focus();
          alert('Vui lòng điền đầy đủ thông tin bắt buộc!');
          return false;
        }
      }
      
      // Validate credit card if selected
      if (paymentMethod === 'card') {
        const cardFields = ['cardNumber', 'cardName', 'expiry', 'cvv'];
        for (let field of cardFields) {
          const element = document.getElementById(field);
          if (!element.value.trim()) {
            element.focus();
            alert('Vui lòng điền đầy đủ thông tin thẻ!');
            return false;
          }
        }
      }
      
      return true;
    }

    // Collect form data
    function collectFormData() {
      const formData = new FormData(document.getElementById('checkout-form'));
      const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
      
      const subtotal = checkoutCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      return {
        items: checkoutCart,
        customerName: formData.get('fullName'),
        customerPhone: formData.get('phone'),
        customerEmail: formData.get('email') || '',
        customerAddress: formData.get('address'),
        deliveryDate: formData.get('deliveryDate'),
        deliveryTime: formData.get('deliveryTime'),
        paymentMethod: paymentMethod,
        orderNotes: formData.get('orderNotes') || '',
        subtotal: subtotal,
        shippingFee: SHIPPING_FEE,
        totalAmount: subtotal + SHIPPING_FEE,
        orderDate: new Date().toISOString()
      };
    }

    // Submit order to backend
    async function submitOrder(orderData) {
      try {
        // Format data according to OrderModel schema
        const orderPayload = {
          orderDate: new Date(),
          customerName: orderData.customerName,
          customerPhone: orderData.customerPhone,
          customerAddress: orderData.customerAddress,
          items: orderData.items.map(item => ({
            productId: item.id || item.productId,
            quantity: item.quantity,
            price: item.price,
            unit: item.unit || ''
          })),
          totalAmount: orderData.totalAmount,
          status: 'pending',
          deliveryDate: orderData.deliveryDate ? new Date(orderData.deliveryDate) : null
        };

        console.log('🛒 Creating order from checkout:', orderPayload);

        const response = await fetch('http://localhost:3004/api/orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(orderPayload)
        });
        
        const result = await response.json();
        console.log('🛒 Order creation result from checkout:', result);
        
        return result;
      } catch (error) {
        console.error('❌ Error submitting order:', error);
        return {
          success: false,
          message: 'Không thể kết nối đến server đặt hàng'
        };
      }
    }

    // Setup payment method handlers
    function setupPaymentMethodHandlers() {
      document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', () => {
          const radio = method.querySelector('input[type="radio"]');
          selectPaymentMethod(radio.value);
        });
      });
    }

    // Setup card number formatting
    function setupCardFormatting() {
      const cardNumber = document.getElementById('cardNumber');
      const expiry = document.getElementById('expiry');
      
      cardNumber?.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        e.target.value = formattedValue;
      });
      
      expiry?.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
          value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
      });
    }

    // Set minimum delivery date (tomorrow)
    function setMinDeliveryDate() {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('deliveryDate').min = tomorrow.toISOString().split('T')[0];
    }

    // Show/hide loading
    function showLoading(show) {
      const overlay = document.getElementById('loading-overlay');
      overlay.style.display = show ? 'flex' : 'none';
      
      const button = document.getElementById('place-order-btn');
      button.disabled = show;
      button.innerHTML = show ? 
        '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...' : 
        '<i class="fas fa-lock"></i> Đặt hàng an toàn';
    }
  </script>
</body>
</html> 